(function() {
  'use strict';

  var stream = flyd.stream;

  var magicSeq = 'abbaba';

  var setMsg = function(msg) { message.innerHTML = msg; };

  document.addEventListener('DOMContentLoaded', function() {
    var click = stream(function(click) {
      btnA.addEventListener('click', click.bind(null, 'a'));
      btnB.addEventListener('click', click.bind(null, 'b'));
    });
    var corrects = flyd.reduce(function(cs, c) {
      var l = cs.length, correct = (c === magicSeq[l]);
      return !correct && l > 0       ? []
           : !correct && l === 0     ? undefined
           : l + 1 < magicSeq.length ? cs.concat(c)
                                     : (setMsg('Combination unlocked!'), []);
    }, [], click);
    var scheduled = flyd.map(function(cor) {
      if (cor.length === 1) return setTimeout(function() {
        setMsg('You\'re not fast enough, try again');
        corrects([]);
      }, 5000);
    }, corrects);
    flyd.map(function(c) { console.log(c); }, corrects);
    stream(function() {
      if (corrects().length === 0 && scheduled.val) clearTimeout(scheduled.val);
    });
  });
})();
